\chapter{ワークC データ取得・分析}

\section{はじめに} 
%本ワークにおいて，何を目的にどのような実験を行ったのか，得られた結果から何が考察できるのかについて報告する内容を整理して記述する．
%例えば次のように記述する．\\
本ワークでは，データの取得と分析を目的とし，実験を行った．
ワークC-1では，ユーザーに脈拍値を知らせることを目的とした実習を行った．
Arduinoに搭載されているLEDマトリクスを活用し，フォトリフレクタからのアナログ出力値の表示を行った．
ワークC-2では，ネットワークを利用し，無線によるデータの取得と分析を目的とした実習を行った．
ArduinoR4WiFiには，WiFiによる無線通信が実装されている．
これを利用し，Arduinoをサーバーとして動作させ，クライアント側にデータを送信することを行い，グラフに描画した．
ワークC-3では，時系列データの平滑化を目的とした実習を行った．
ワークC-2で得られたデータには誤差が含まれている．これを除去することを目的として実習を行った．
平滑化の方法として，単純移動平均法と指数平滑移動平均法を用いた．これでデータの平滑化を行い，それぞれグラフに描画した．

%（例）本ワークでは～を目的とし，～の実験を行った．
%実験を通じて～の結果を得た．
%それらの結果より，～であることを明らかにする．

\section{方法} 
%本ワークで行った実験に関する条件や学んだ理論について記述する．
%以下の内容が記載されているか注意しながら進めること．
%例文は不慣れな学生向けの一例にすぎず，必ずしも同様の書き方をする必要はない．
%必要に応じて図表や数式を用いて説明することが求められる．

%\begin{itemize} 
 %   \item[・] 実験に用いた材料およびその性能，型式など\ （例）○○の評価では，○○（型式: ○○），○○（型式: ○○），および○○（型式: ○○）を図〇〇に示すように使用した． 
  %  \item[・] データの取得方法および作業手順\ （例）○○データの取得のため，○○を用いて○○を測定した．まず〇〇秒間〇〇し，次に〇〇し$\cdots$，最後に〇〇した． 
   % \item[・] 評価方法\ （例）取得されたデータを〇〇法により〇〇し，〇〇を評価した． \end{itemize}

%以下のように記述する．

%（例）本ワークでは$\cdots$を目的に$\cdots$を行った．
%○○の評価では，光センサとして○○と，○○，および○○を図〇〇に示すように配線した．
%また，○○の評価のため，○○を行った．○○のデータ取得のため，まず〇〇秒間〇〇し，次に〇〇し$\cdots$最後に〇〇した．
%取得されたデータを〇〇法により〇〇し，〇〇を評価した．

\subsection{ワークC-1 LEDマトリクスの活用}
ワークC-1では，Arduinoとフォトリフレクタを用いて，フォトリフレクタと障害物の距離を変化させ，アナログ値を取得した．
また，取得したアナログ値は，電圧値に変換し，LEDマトリクスを用いて，表示を行った．
実験に用いた道具の仕様は，表\ref{c1_tools}に示す．

\begin{table}[H]
    \centering
    \caption{ワークC-1で用いた道具の仕様}
    \begin{tabular}[H]{|c|c|c|} \hline
        製品名&数量&仕様\\ \hline
        マイコンボード&1個&Arduino Uno R4 WiFi\\ \hline
        フォトリフレクタ&1個&LBR-127HLD\\ \hline
        抵抗器&1個&330$\Omega$\\ \hline
        抵抗器&1個&3.3k$\Omega$\\ \hline
        ブレッドボード&1個&165401020E\\ \hline
        ジャンパーワイヤー&複数本&165012000E\\ \hline
    \end{tabular}
    \label{c1_tools}
\end{table}

ブレッドボードには，フォトリフレクタを使った回路を組んだ．配線図は，図\ref{c1_wiring_diagram}に示す．
ブレッドボードに実装した回路は，図\ref{c1_example_circuit}に示す．
\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c1/c1_wiring_diagram.png}
    \caption{ワークC-1の配線図}
    \label{c1_wiring_diagram}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c1/c1_example_curcuit.JPG}
    \caption{ワークC-1の実装回路}
    \label{c1_example_circuit}
\end{figure}
ワークC-1では，障害物が必要となる．今回は書籍を用いて実験を行った．
記録を表示するために，今回はLEDマトリクスを用いている．LEDマトリクスの表示例は，図\ref{c1_display}に示す．
実験は，距離が0.5 cmから5.0 cmまでのLEDマトリクスに表示された記録をとった．記録の取り方の様子は，図\ref{c1_measurement}に示す．
フォトリフレクタと障害物の距離は，0.5 cmずつ記録を取得する．
取得した記録は，csvファイルに保存し，変化の様子をグラフに描画する．
\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c1/c1_display.JPG}
    \caption{ワークC-1のLEDマトリクス表示例}
    \label{c1_display}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c1/c1_measurement.JPG}
    \caption{ワークC-1の記録取得の様子}
    \label{c1_measurement}
\end{figure}

\subsection{ワークC-2 ネットワークを介したデータの取得と分析}
ワークC-2では，ArduinoR4WiFiを用いて，WiFiによる無線通信を行い，データの取得と分析を行った．
データ取得のためのセンサは，CdSセルを用いた．
実験に用いた道具の仕様は，表\ref{c2_tools}に示す．
\begin{table}[H]
    \centering
    \caption{ワークC-2で用いた道具の仕様}
    \begin{tabular}[H]{|c|c|c|} \hline
        製品名&数量&仕様\\ \hline
        マイコンボード&1個&Arduino Uno R4 WiFi\\ \hline
        CdSセル&1個&GL3516\\ \hline
        ブレッドボード&1個&165401020E\\ \hline
        ジャンパーワイヤー&複数本&165012000E\\ \hline
        クライアント側PC&1台&MacBookAir(M4)\\ \hline
    \end{tabular}
    \label{c2_tools}
\end{table}
ブレッドボードには，CdSセルを使った回路を組んだ．配線図は，図\ref{c2_wiring_diagram}に示す．実装回路は，図\ref{c2_example_circuit}に示す．
\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c2/c2_wiring_diagram.png}
    \caption{ワークC-2の配線図}
    \label{c2_wiring_diagram}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=10cm]{fig_work_C/c2/c2_example_circuit.JPG}
    \caption{ワークC-2の実装回路}
    \label{c2_example_circuit}
\end{figure}

記録は，CdSセルの上部に手をかざし，CdSセルとの距離を変えることで，様々なデータを取った．
記録は5つの手順を踏んで取得した．まず初めに，手をかざさず，記録を20秒取得した．
次に，手をCdSセルの上部およそ9 cmの高さでかざし，記録を20秒取得した．
次に，手をCdSセルの上部およそ6 cmの高さでかざし，記録を20秒取得した．
次に，手をCdSセルの上部およそ3 cmの高さでかざし，記録を20秒取得した．
最後に，手をかざさず，記録を20秒取得した．
この手順は表\ref{c2_process}に示す．記録の取得の様子は，図\ref{c2_measurement}に示す．
\begin{table}[H]
    \centering
    \caption{ワークC-2の記録取得手順}
    \begin{tabular}[H]{|c|c|c|} \hline
        手順&手の位置&記録時間(秒)\\ \hline
        1&手をかざさない&20\\ \hline
        2&CdSセルの上部およそ9cmの高さで手をかざす&20\\ \hline
        3&CdSセルの上部およそ6cmの高さで手をかざす&20\\ \hline
        4&CdSセルの上部およそ3cmの高さで手をかざす&20\\ \hline
        5&手をかざさない&20\\ \hline
    \end{tabular}
    \label{c2_process}
\end{table}

\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c2/c2_measurement.JPG}
    \caption{ワークC-2の記録取得の様子}
    \label{c2_measurement}
\end{figure}
これにより，データの取得を行った．このデータをクライアントのPCに送信する．
ArduinoをWebサーバーとして起動する．このサーバーに，WiFiを利用して，クライアント側のPCと通信することで，データの送信をJSONを利用して行った．
送信されたデータは，PCがcsvファイルとして保存する．このファイルを用いて，グラフの描画を行う．
\subsection{ワークC-3 時系列データの平滑化}
ワークC-2で得られたグラフには多少のばらつきが見られた．これを除去するために，ワークC-3では，時系列データの平滑化を行う．
本ワークでは，平滑化の方法として，単純移動平均法(SMA)と指数平滑移動平均法(EMA)を用いた．
単純移動平均法は，過去データを一定期間とりだし，その平均値を算出し，グラフにする手法である\cite{MA}．
単純移動平均法は，$a_k$をデータ，$n$をとるデータの範囲，平均値を$SMA_k$とすると，式\eqref{SMA}のようになる．

\begin{equation}
        SMA_k = \frac{a_{k-4}+a_{k-3}+a_{k-2}+a_{k-1}+a_{k}}{n}
    \label{SMA}
\end{equation}
本ワークでは，5つのデータを利用して，平均値を算出する．

指数平滑移動平均法は，過去のデータに対し，指数的な減衰をほどこし，現在のデータが大きい影響を与える平滑手法である\cite{MA}．
指数平滑移動平均法は，$a_k$をデータ，指数平滑移動平均を$EMA_k$，取得するデータ範囲を$n$とすると，計算式は式\eqref{EMA}のようになる．
また，n個のデータがないときは，単純移動平均法を用いる．

\begin{equation}
    EMA_k = (a_k - EMA_{k-1})*\frac{2}{n+1}+EMA_{k-1}
    \label{EMA}
\end{equation}

本ワークでは，5つのデータを利用して，指数平滑移動平均を算出する．

\clearpage \section{結果} 
%実験から得られた結果について記述し，その中で読者の興味を引く結果がどれであり，それが何であるかを述べる．
%グラフや表にまとめるべきデータがあれば適切に図表として示すこと．
%本節の目的は図表を活用して要点を簡潔にまとめることであり，図表を文章にするのではない点に注意する．

\subsection{ワークC-1 LEDマトリクスの活用}
フォトリフレクタと障害物の距離は，距離が長いほど電圧値が大きくなる事が確認できた．
得られた実験値は，表\ref{result_c1_value}に示す．
\begin{table}[H]
    \centering
    \caption{ワークC-1で得られた実験値}
    \begin{tabular}{|c|c|} \hline
        距離[cm]&電圧値[V]\\ \hline
        0.5&1.85\\ \hline
        1.0&3.29\\ \hline
        1.5&3.97\\ \hline
        2.0&4.20\\ \hline
        2.5&4.54\\ \hline
        3.0&4.61\\ \hline
        3.5&4.70\\ \hline
        4.0&4.74\\ \hline
        4.5&4.78\\ \hline
        5.0&4.81\\ \hline
    \end{tabular}
    \label{result_c1_value}
\end{table}

また，この値を元にグラフを描画した．グラフは，図\ref{c1_result}に示す．
図\ref{c1_result}にあるように，距離が長くなればなるほど，電圧値が大きくなる傾向が確認できた．
変化の様子は，対数関数のように推移していることが読み取れた．
\begin{figure}[H]
    \centering
    \includegraphics[width=5cm]{fig_work_C/c1/result_C1.png}
    \caption{フォトリフレクタと障害物間の距離と電圧値の関係}
    \label{c1_result}
\end{figure}
\subsection{ワークC-2 ネットワークを介したデータの取得と分析}
ワークC-2で得られたグラフから，CdSセルと障害物との距離に電圧値の変化が確認できた．
この変化は，障害物がCdSセルに近いほど，電圧値が高いことが確認できた．
また，手順1と手順5では，電圧値がほぼ同じであることが確認できた．
電圧値は，同じ距離を維持している場合は，ほぼ変動なく同じ値が出ることが確認できた．
取得したグラフは，図\ref{c2_result_C2.png}に示す．
\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c2/result_C2.png}
    \caption{ワークC-2で得られたグラフ}
    \label{c2_result_C2.png}
\end{figure}

\subsection{ワークC-3 時系列データの平滑化}
ワークC-2で得られたデータをそれぞれの手法を用いて平滑化を行い，グラフにした．
単純移動平均法を用いたグラフは，図\ref{c3_SMA}に示す．
また，指数平滑移動平均法を用いたグラフは，図\ref{c3_EMA}に示す．
単純移動平均法を用いたグラフは角張っているのに対し，指数平滑移動平均法を用いたグラフは滑らかであることが確認できた．

\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c3/result_C2_SMA.png}
    \caption{ワークC-3で得られた単純移動平均法のグラフ}
    \label{c3_SMA}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=10cm]{fig_work_C/c3/result_C2_EMA.png}
    \caption{ワークC-3で得られた指数平滑移動平均法のグラフ}
    \label{c3_EMA}
\end{figure}
\clearpage \section{考察} 
%本ワークで得られた結果について考察する．
%例えば，以下のように記述する．

%（例）本ワーク○○では○○の結果が得られたが，これは理論値と比較して○○な結果である．これは○○が原因であると考えられる．
\subsection{ワークC-1 LEDマトリクスの活用}
ワークC-1にて，描画されたグラフである，図\ref{c1_result}から，対数関数のように推移することが確認できた．
これは，光の特性のひとつである光の逆二乗則によるものだと考えられる．

本ワークでは，光センサとして，フォトリフレクタを利用した回路構成になっている．
フォトリフレクタは，赤外線LEDとフォトトランジスタで構成されている．
この二つの部品で，電圧値の出力に関係するのは，フォトトランジスタである．
仕組みとして，赤外線LEDからの赤外線が障害物に反射し，フォトトランジスタに入光する．
その光量が多いほど，フォトトランジスタに流れる電流量が大きくなる．よって，トランジスタの抵抗値は減少する．
本ワークでは，回路の構成から可変抵抗器はフォトトランジスタのみである．
よって回路の電圧に影響を与えるのは，フォトトランジスタのみである．

そして，照度には距離の二乗に反比例する法則が存在する\cite{light}．この法則は，光と同類である赤外線にも適用される．
そのため，光の逆二乗則に従い，障害物とフォトリフレクタの距離が遠いほど電圧値が大きくなる．
例として，フォトトランジスタとの距離が１のときは，照度も１である．
距離が2となると，照度は4分の1となり，光量が大きく減少する．
距離が3となると，照度は9分の1となり，距離2のときよりもさらに大きく光量が減少する．
よって，フォトリフレクタと障害物間の距離により光量が対数関数のように減少する．
光量が減少したことにより，フォトトランジスタの特性から電流も同様に少なくなり，抵抗値が増加し，電圧値が増加したと考えられ，変化の様子として，対数関数のようになったと考えられる．

このような特性は，身近な製品として自動ドアが利用されている．
自動ドアには，赤外線センサを利用し，人の有無を検知している製品もある\cite{automatic_door}．
この赤外線センサの電圧変化を利用し，電圧が一定値を超えた際にドアを開いていると考えられる．
\subsection{ワークC-2 ネットワークを介したデータの取得と分析}
本ワークで用いたセンサは，CdSセルである．CdSセルは，光量によって抵抗値が変動する部品である．
CdSセルの抵抗値は，光量が多いほど抵抗値が小さくなり，光量が少ないほど抵抗値が大きくなる特性を持つ\cite{cdscell}．
そのため，オームの法則から，抵抗値が大きいほど，電圧が大きくなる．本ワークにおける実験では，手が光を遮る役割をしており，CdSセルとの距離が近いほど，CdSセルの受光部に入る光量が減少する．
よって，手がCdSセルに近いほど，CdSセルの抵抗値が大きくなり，電圧値が大きくなり，図\ref{c2_result_C2.png}のように変化したと考えられる．

また，20から80秒間の手をかざしている間には，電圧値のブレが生じている．これは，人間が手でやっていることなので，同位置で静止し続けることが困難であることによる誤差だと考えられる．
このような誤差を除去するためには，硬い板材とこれを支える器具を用いることで，手ぶれによる誤差を減少させる事が期待できる．
板材の色は，光を吸収することがほとんどない白色が適していると考えられる\cite{coler}．
\subsection{ワークC-3 時系列データの平滑化}
本ワークでは，二つの平滑化手法を実行した．
単純移動平均法では，全体の傾向を確認でき，計算方法が容易であるため，実践しやすい．しかし，その特性上，過去データと現在データが均一な価値を持つため，グラフの形状からも確認できるように急激な変化に素早く対応できない．
一方で，指数平滑移動平均は，急激な変化に素早い反応を見せる特徴を持っている．しかし，現在データに強く影響されるため，全体の傾向の把握には向いていない\cite{MA}．

これらを使い分けるためには，期間の設定と値の変動具合が重要になる．短期間の場合では，EMAが向いており，長期間の場合には，SMAが向いている\cite{MA_fx}．
本ワークの場合では，100秒間の短期間におけるデータの取得を行った．また，電圧値の変動が激しい．そのため，指数平滑移動平均法が向いていると考えられる．
\section{おわりに} 
%ワークを通じて得られた知見や考察，目的の達成度などについて記述し，本ワークを総括する．
%単なる感想ではなく，客観的な総括を行うように注意すること．
本ワーク全体を通して，ユーザー対して情報の表示を行い，ArduinoをWebサーバーとして利用することにより，情報通信の無線化，ならびにデータの取得，分析を2つの手段を用いて行った．
ワークC-1では，ArduinoのLEDマトリクスを利用した情報の伝達を実現した．
ワークC-2では，PCとArduinoの無線通信を行い，Arduinoが取得したデータの転送，ならびにグラフの描画を行った．
ワークC-3では，ノイズが含まれたデータを2つのデータの平滑手段を用いて，ノイズの除去を行った．同時に2つの長所短所を見極め，今回のケースでは，どちらが適切な平滑手段かの検討を行った．
\clearpage

