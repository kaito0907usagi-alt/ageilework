\chapter{導入実習}

\section{はじめに}

環境の明るさを測定するセンサは，我々の生活の様々な場面で使用される．
例えば，硫化カドミウム (CdS) セルなどに代表されるフォトレジスタは入射する光の量に応じてその抵抗値を変化させる性質を持ち，自動照明制御やディスプレイの明るさ調整などに用いられている\cite{川口慎一朗1966cds}．
また，フォトトランジスタは光が入射することで電流が流れる半導体デバイスであり，カメラ用の受光素子など高速応答が必要なシステムに用いられている\cite{yusa1986SIT,中村力1987ゲート蓄積型}．
それぞれのセンサに用いられる素子には固有の特性があり，それらを利用する際には，それぞれの素子の特性に関する理解を深めておくことが重要である．
本導入実習では，マイコンボードとフォトリフレクタを用いた簡易的な脈波観察システムの作成を通してセンサの原理とその扱い方を理解し，実習への導入を行う．
実験では赤外LEDとフォトトランジスタで構成される反射型フォトリフレクタに指先を近接させ，出力信号の変動を記録し，そのピーク周期から脈波の観察が可能か確認した．

%-----------------------------------------------------------------------------------

\section{実験方法}

\subsection{脈拍測定の原理}

\begin{wrapfigure}{r}{0.3\textwidth}
    \vspace{-2em}
    \centering
    \includegraphics[width=0.2\textwidth,clip]{fig/prm.png}
    \caption{光電容積脈波計測法の模式図}
    \label{prm}
\end{wrapfigure}

脈波は心臓から駆出された血液が動脈系を通して末梢方向に波及する波動であり\cite{石川太郎1974照明制御システムへの半導体応用, 安藤譲二1990光電式脈波計測の応用}，その発生頻度を数値化した脈拍数は生命維持に必要な循環機能に関連した代表的なバイタルサインの一つである\cite{小林宏光2009脈拍数測定の正確さと測定時間との関係}．
脈波の測定法として，心電図法，血圧計測法，心音図法，光電脈波法が知られており\cite{elgendi2019use}，なかでも光電容積脈波計測法\cite{hertzman1938blood}は，光センサを使った方法である．
光電脈波法で使用するセンサには，測定方法の違いから，透過型と反射型があり，透過型では，体表面から赤外線や赤色光を照射し，心臓の脈動に伴って変化する血流量の変化を，体内を透過する光の変化量として計測する．
この方法では，指先や耳たぶなど透過しやすい箇所に計測箇所が限定される．
反射型では，図\ref{prm}に示すように赤外線や赤色光または緑色光を照射し，受光素子用いて生体内から反射した光を測定する．
脈動に伴って変化する血管の容量を検出することで，脈波を測定することができる．
反射光を計測することから，測定箇所が限定される透過型よりも自由度が高く，ウェアラブル端末への搭載など幅広い用途への応用が可能である．

% \begin{wrapfigure}{r}{0.4\textwidth}
%     \vspace{0em}
%     \centering
%     \includegraphics[width=0.35\textwidth,clip]{fig/TEK00002.PNG}
%     \caption{出力信号に適切なノイズ除去および増幅を行った波形}
% \end{wrapfigure}

血液中の酸化ヘモグロビンは特定の波長の光を吸収する性質を持ち，脈拍に応じて皮膚下の血液量も変化するため反射される光の量が変化する．
生体に照射された光は，血液以外の組織層，動脈層，静脈層の各層で反射され受光部に到達する．
心臓から拍出された動脈血は，脈波と呼ばれるように波のような形で血管内を移動する．
短時間で，厚みが変化するのは脈動をしている動脈血のみであり，静脈およびその他の組織は，短時間では厚みが変化しない．
つまり，動脈を流れる血液量が変化することで受光部へ達する光の量も変わり，センサの受け取る信号が変化する．
その時間変化を記録し解析することで脈波を測定することができる．

% \subsection{CdSセルの原理}

% \begin{wrapfigure}{r}{0.35\textwidth}
% \vspace{-2em}
% \centering
% \includegraphics[width=0.3\textwidth,clip]{fig/cds_characteristic.pdf}
% \\[-1em]
% \caption{CdSセルの特性}
% \label{cds}
% \end{wrapfigure}

% 明るさを測定するための基本的な電子部品として，硫化カドミウム（CdS）の性質を利用したセンサ（CdSセル）がある．
% 図\ref{xxx}はCdSセルを照らす照度と抵抗値の関係を示したものである．
% 本実習で用いるCdSセルのもつ抵抗値は暗い環境において約1 $\rm{M}\Omega$程度，明るい環境において数$\rm{k}\Omega$程度となる．

% 光センサの利用目的のひとつは「明るい」または「暗い」をおおまかに判別することである．
% 光センサを利用した明るさの判別を実現するには，まず，それぞれの環境下におけるセンサ両端の電圧を測定し，値を記録する．
% 次に，それぞれの条件を判別可能な適切な閾値（例えば両者の平均値）を設定する．
% 判別時はセンサ両端の電圧がその閾値を上回るかにより条件分岐することで明るさを判定する．
% 以下の図\ref{xxx}およびプログラムは，CdSセルの特性を活用し，照度の変化を測定するためのものである．

\subsection{フォトリフレクタの原理}

\begin{wrapfigure}{r}{0.35\textwidth}
    \vspace{-2em}
    \centering
    \includegraphics[width=0.15\textwidth,clip]{fig/LBR-127HLD.png}
    \caption{LBR-127HLDの外観}
\end{wrapfigure}

フォトリフレクタは，光の反射を利用して物体の存在や距離を検出するセンサである.
フォトリフレクタは発光部と受光部で構成されており，発光部から放射された光が物体に反射し，その反射光を受光部で検出する．
具体的には，光を発する発光素子（通常はLED）と，反射した光を検出する受光素子（通常はフォトダイオードまたはフォトトランジスタ）の2つの部品で構成される．
本実験で用いるフォトリフレクタは赤外LEDから放出された赤外光を物体に反射させ，フォトトランジスタで受光することで出力電流が変化する光センサである．
脈波の測定では，センサに指先を近接させ，指先を流れる血流の疎密に応じたその明暗の変化からフォトトランジスタのコレクタ側端子の電位を出力信号として取得し，ピーク値の間隔の逆数から脈拍を算出することができる．
つまり，動脈を流れる血液量が変化することで受光部へ達する光の量も変わり，センサの受け取る信号が変化する．
血液量が多いときは光の吸収が多く，反射される光が少なくなり，フォトトランジスタのコレクタ電圧は高くまる．
逆に血液量が少ないときは光の吸収が少なく，反射される光が多くなることから，フォトトランジスタのコレクタ電圧は低くなる．

\subsubsection*{フォトダイオード}

\begin{wrapfigure}{r}{0.4\textwidth}
    \vspace{-4em}
    \centering
    \includegraphics[width=0.35\textwidth,clip]{fig/photodiode.pdf}
    \caption{フォトトダイオードの模式図}
\end{wrapfigure}

フォトダイオードは受光素子が受けた光を電気エネルギーに変換する素子である．
光子がp-n接合を持つダイオードの接合部に入射すると，内部で電子--正孔対が生成される．
生成された電子--正孔対は，電場の影響を受けて分離され，電子はn側へ，正孔はp側へ移動する．
分離されたキャリアが外部回路を通じて移動することで，電流が生成され，この電流（光電流）は入射する光の強度に比例する．
この特性を利用して，フォトダイオードは光の強度を測定するセンサとして使用される．

\subsubsection*{フォトトランジスタ}

\begin{wrapfigure}{r}{0.35\textwidth}
    \vspace{-2em}
    \centering
    \includegraphics[width=0.3\textwidth,clip]{fig/phototransistor.pdf}
    \caption{フォトトランジスタ}
    \label{phototransistor}
\end{wrapfigure}

フォトトランジスタは，図 \ref{phototransistor} に示すように，フォトダイオードとトランジスタが一体化したものである．
光が当たるとフォトダイオード部に電流（光電流）が流れるが，光電流は微小な電流であり，そのまま扱うのは困難であるためトランジスタによって測定可能な程度に増幅する．
この増幅された出力電流によって，照度が低く光電流が小さい場合でも，大きな出力が得られるので感度を上げることができる．
図 \ref{photoreflector_characteristic} (左) に示す回路を作成したとき，フォトダイオードに図 \ref{photoreflector_characteristic} (右上) に示すような光が入射すると，トランジスタの出力は，図 \ref{photoreflector_characteristic} (右下) に示すような応答（コレクタの電位変化）が得られる．
コレクタ--エミッタ間に増幅電流が流れると，コレクタ-エミッタ間は短絡されるので，フォトトランジスタの出力電位は低下する．
逆に，フォトトランジスタに反射光が入射しないとき，フォトトランジスタの出力電位は高電位になる．

\begin{figure}[h]
    \centering
    \includegraphics[width=100mm]{fig/photoreflector_characteristic.pdf}
    \caption{LBR-127HLDの試験回路と出力信号\cite{LBR-127HLD}}
    \label{photoreflector_characteristic}
\end{figure}

\subsection{装置}
\begin{tabular}{l r}
マイコンボード（型式：Arduino Uno R4 WiFi） & 1個 \\
% CdSセル（型式：GL3516）& 1個 \\
フォトリフレクタ（型式：LBR-127HLD）& 1個 \\
赤色LED（型式：L5-EKR2530-12500）& 1個 \\
抵抗器（330 $\Omega$） & 2個 \\
抵抗器（3.3 $\rm{k}\Omega$） & 1個 \\
ブレッドボード（型式：165401020E）& 1個 \\
ジャンパーワイヤ（型式：165012000E） & 1式 \\
脈拍計（型式：UP-200）& 1台 \\
\end{tabular}

\subsection{実験手順}

図\ref{cirkit}に示すようにブレッドボード上にArduinoとフォトリフレクタ，LEDおよび抵抗器を組み合わせた回路を作成した．
Arduinoのアナログ入力端子（A0）をフォトトランジスタのコレクタ端子と接続し，その電圧波形をシリアルプロッタで出力した．
シリアルプロッタで取得可能な約50点のサンプルについてグラフに描画した．
電圧を測定た上でCdSセル両端の抵抗値を算出し，記録した上でグラフにまとめた．
作成した脈波観察システムの性能を評価するため，市販の脈拍センサ\cite{UP-200}と同時に脈拍の測定を行い，比較を行った．

\begin{figure}[h]
    \centering
    \includegraphics[height=70mm]{fig/cirkit.png}
    \caption{接続図}
    \label{cirkit}
\end{figure}

%-----------------------------------------------------------------------------------
\clearpage
\section{実験結果}

図\ref{result1}に示す回路をブレッドボード上に作成し，図\ref{result2}のように指先をフォトリフレクタを配置した．
フォトリフレクタに指先を当て，出力電圧を測定し記録することで，図\ref{result_tutorial}の結果を得た．
出力値に周期的な変動が見られ，その周期は約800 msであったことから，脈拍は75 bpmであったと推定できる．
表\ref{table1}は市販の脈拍計で測定された脈拍との比較であり，おおよそ同等の値が取得できていることが確認できる．
以上の結果から作成した簡易脈波観察システムにより，脈波の観察が可能であった．
% これらの結果より，マイコンボードとフォトリフレクタを用いた脈拍計測の実現可能性が示唆されたが，ハードウェア，ソフトウェアおよびデータの取得・分析方法について改良の余地が見出された．
% \begin{figure}[h]
%     \centering
%     \includegraphics[width=120mm]{fig/result_1.png}
%     \caption{作成した簡易脈波観察システムおよび脈波測定の様子}
%     \label{result_1}
% \end{figure}

\begin{figure}[h]
    \centering
    \begin{minipage}[b]{0.45\textwidth}
      \centering
      \includegraphics[height=45mm]{fig/result1.png}
      \caption{作成した簡易脈波観察システム}
      \label{result1}
    \end{minipage}
    % \hspace{0.05\textwidth}
    \begin{minipage}[b]{0.45\textwidth}
      \centering
      \includegraphics[height=45mm]{fig/result2.png}
      \caption{脈波測定の様子}
      \label{result2}
    \end{minipage}
  \end{figure}
  


\begin{figure}[h]
    \centering
    \includegraphics[width=120mm]{fig/result_tutorial.png}
    \caption{測定結果の描画例}
    \label{result_tutorial}
\end{figure}

\begin{table}[ht]\caption{脈拍の測定結果}
    \centering
    \begin{tabular}{|l||c|c|c|c|c|c|c|}
      \hline
      \multirow{2}{*}{} & \multicolumn{5}{c|}{脈拍[bpm]}      \\ \cline{2-6}
                        & １回目 & 2回目 & 3回目& 4回目 & 5回目  \\ \hline
      自作した脈波観察システム   & 75    & 71   & 75   & 75   & 71   \\ \hline
      市販の脈拍計（UP-200）    & 72    & 73   & 72   & 71   & 72   \\ \hline
    \end{tabular}
    \label{table1}
  \end{table}

%-----------------------------------------------------------------------------------
\clearpage
\section{考察}

表\ref{table1}に示す市販の脈拍計との比較から，本実習で作成した脈拍観察システムを用いて，簡易的な脈波の観察が可能であることが確認された．
しかしながら，サンプリング周期が50 msと長いため，正確な脈拍測定は実現できていないと考えられる．
正確な測定を実現するためには，より短いサンプリング周期が必要である．
本実習では，脈拍の取得に際して，グラフから信号の周期を手動で読み取り，計算を行ったが，リアルタイムでの脈拍観察には，信号を解析し，自動で脈拍を計算するプログラムの開発が必要である．
特に，ピーク値の大小が見られることから，単純な閾値によるピーク検出は困難であり，前後の出力値の差分からピークを判定する手法が求められる．
さらに，ピーク検出の精度を向上させるためには，波形が十分に滑らかである必要があり，信号に含まれる高周波ノイズの除去が不可欠である．
また，波形のベースラインが変動するため，低周波ノイズの除去も併せて必要である．
これらから，ピーク値の検出には，適切なバンドパスフィルタを設けてノイズを低減することが求められる．
今回の実験では，Arduino IDEに標準で付属するシリアルモニタを用いたため，長時間にわたるデータの取得が困難であった．
今回用いたマイコンボードにはWi-Fi通信機能が搭載されているため，この機能を利用してデータを記録・解析できるシステムの構築が望まれる．



%-----------------------------------------------------------------------------------
\section{おわりに}

本導入実習では，センサの原理とその取り扱いに関する理解を深めることを目的として，マイコンボードを用いた簡易的な脈波観察システムの作成を行った．
実験では，赤外LEDとフォトトランジスタで構成された反射型フォトリフレクタに指先を近接させ，出力信号の変動から脈波を測定した．
具体的には，フォトリフレクタに近接させた指先の動脈を流れる血流量の変化に伴い，赤外LEDから照射された光を受けたフォトトランジスタのコレクタ端子の電圧が変化し，その出力変動が確認された．
これらの結果により，Arduinoを用いた脈拍計測の実現可能性が示唆されたが，ハードウェア，ソフトウェア，およびデータ取得方法にいくつかの課題が明らかとなった．
ハードウェアに関しては，バンドパスフィルタを導入してノイズを低減し，出力信号を増幅することでピーク値の検出を容易にする工夫が必要である．
ソフトウェアに関しては，現状では脈拍の計算を手動で計算を行っているため，波信号を解析し，自動で脈拍を計算するプログラムの開発が求められる．
さらに，現状では長時間にわたるデータの取得が困難であるため，マイコンボードに搭載された通信機能を利用してデータの記録と解析が行えるようにすることが望まれる．
今後，これらの課題に取り組むことで，脈拍測定システムの完成が見込まれる．

%-----------------------------------------------------------------------------------

\clearpage
\section*{付録}

\subsection*{脈波取得のためのArduinoのスケッチ}

\begin{figure}[h]
\centering
\begin{lstlisting}[caption=tutorial.ino, label=src, escapechar=\@]
const int outputPin = 4;           // デジタル出力ピンの設定
const int threshold = 690;          // アナログ入力の閾値

void setup() {
  Serial.begin(9600);               // シリアル通信の開始
  pinMode(outputPin, OUTPUT);       // 出力ピンのモード設定
}

void loop() {
  uint16_t v = analogRead(A0);      // アナログ入力を読み取る
  Serial.println(v);                // 読み取った値をシリアルモニタに出力

  if (v > threshold) {              // アナログ入力の値が閾値を超えるかどうかで出力を制御
    digitalWrite(outputPin, LOW);
  } else {
    digitalWrite(outputPin, HIGH);
  } 
   
  delay(50);                       // 次のループまで@50@ミリ秒待機
}
\end{lstlisting}
\end{figure}